<!DOCTYPE html>
<html>
<head>
    <title>Phase 1 Integration Tester</title>
    <style>
        body { font-family: 'Segoe UI', monospace; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .container { max-width: 1400px; margin: 0 auto; }
        .test-panel { 
            background: rgba(255,255,255,0.95); 
            color: #333;
            padding: 25px; 
            margin: 20px 0; 
            border-radius: 12px; 
            box-shadow: 0 8px 32px rgba(0,0,0,0.3); 
            backdrop-filter: blur(10px);
        }
        .success { border-left: 5px solid #28a745; }
        .error { border-left: 5px solid #dc3545; }
        .warning { border-left: 5px solid #ffc107; }
        .info { border-left: 5px solid #17a2b8; }
        table { border-collapse: collapse; width: 100%; margin: 15px 0; font-size: 13px; }
        th, td { border: 1px solid #dee2e6; padding: 10px; text-align: left; }
        th { background: linear-gradient(135deg, #6c757d, #495057); color: white; }
        .highlight-row { background-color: #fff3cd; }
        .compare-table th { background: linear-gradient(135deg, #007bff, #0056b3); }
        pre { background: #f8f9fa; padding: 20px; border-radius: 8px; overflow-x: auto; font-size: 12px; }
        .metric-card { 
            display: inline-block; 
            margin: 15px; 
            padding: 20px; 
            background: linear-gradient(135deg, #28a745, #20c997); 
            color: white;
            border-radius: 10px; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            min-width: 180px;
            text-align: center;
        }
        .diff-highlight { background-color: #ffecb3; border: 2px solid #ff9800; }
        .test-step { 
            background: rgba(108, 117, 125, 0.1); 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 8px;
            border-left: 4px solid #6c757d;
        }
        h1 { text-align: center; margin-bottom: 30px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        h2 { color: #495057; border-bottom: 2px solid #dee2e6; padding-bottom: 10px; }
        .status-badge { 
            padding: 5px 10px; 
            border-radius: 15px; 
            font-weight: bold; 
            font-size: 11px; 
        }
        .pass { background: #d4edda; color: #155724; }
        .fail { background: #f8d7da; color: #721c24; }
        .pending { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß¨ Phase 1 Integration Tester</h1>
        <p style="text-align: center; font-size: 18px; margin-bottom: 30px;">
            <strong>Mission:</strong> Validate new parseAdSetCSV() and convertOutputFilesToDashboard() functions against current dashboard output
        </p>
        
        <div id="test-results"></div>
    </div>

    <script>
        // Simplified versions of the new functions for testing
        function parseAdSetCSV(csvContent) {
            const lines = csvContent.trim().split('\n');
            if (lines.length === 0) return [];
            
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const dataRows = lines.slice(1);
            
            return dataRows.map(row => {
                const values = row.split(',').map(v => v.trim().replace(/"/g, ''));
                const rowObj = {};
                headers.forEach((header, index) => {
                    rowObj[header] = values[index] || '';
                });
                
                // Convert to expected format
                return {
                    date: rowObj['Date'] || '',
                    campaignName: rowObj['Campaign Name'] || '',
                    adSetName: rowObj['Ad Set Name'] || '',
                    sessions: parseFloat(rowObj['Sessions']) || -999,
                    totalUsers: parseFloat(rowObj['Total Users']) || -999,
                    qualityCustomers: parseFloat(rowObj['Quality Customers']) || -999,
                    usersToCustomersRatio: parseFloat(rowObj['Users to Customers Ratio']) || -999,
                    bounceRate: parseFloat(rowObj['Bounce Rate (%)']) || -999,
                    avgSessionDuration: parseFloat(rowObj['Avg Session Duration (min)']) || -999,
                    pageViews: parseFloat(rowObj['Page Views']) || -999,
                    addToCarts: parseFloat(rowObj['Add to Carts']) || -999,
                    checkouts: parseFloat(rowObj['Checkouts']) || -999,
                    orders: parseFloat(rowObj['Orders']) || -999,
                    revenue: parseFloat(rowObj['Revenue (INR)']) || -999,
                    conversionRate: parseFloat(rowObj['Conversion Rate (%)']) || -999,
                    adSetLevelSpent: parseFloat(rowObj['Ad Set Level Spent']) || -999
                };
            });
        }

        function parseTopLevelCSV(csvContent) {
            const lines = csvContent.trim().split('\n');
            if (lines.length === 0) return [];
            
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const dataRows = lines.slice(1);
            
            return dataRows.map(row => {
                const values = row.split(',').map(v => v.trim().replace(/"/g, ''));
                const rowObj = {};
                headers.forEach((header, index) => {
                    rowObj[header] = values[index] || '';
                });
                
                return {
                    date: rowObj['Date'] || '',
                    sessions: parseFloat(rowObj['Sessions']) || -999,
                    totalUsers: parseFloat(rowObj['Total Users']) || -999,
                    qualityCustomers: parseFloat(rowObj['Quality Customers']) || -999,
                    usersToCustomersRatio: parseFloat(rowObj['Users to Customers Ratio']) || -999,
                    bounceRate: parseFloat(rowObj['Bounce Rate (%)']) || -999,
                    avgSessionDuration: parseFloat(rowObj['Avg Session Duration (min)']) || -999,
                    pageViews: parseFloat(rowObj['Page Views']) || -999,
                    addToCarts: parseFloat(rowObj['Add to Carts']) || -999,
                    checkouts: parseFloat(rowObj['Checkouts']) || -999,
                    orders: parseFloat(rowObj['Orders']) || -999,
                    revenue: parseFloat(rowObj['Revenue (INR)']) || -999,
                    conversionRate: parseFloat(rowObj['Conversion Rate (%)']) || -999
                };
            });
        }

        function convertOutputFilesToDashboard(topLevelData, adSetData, dateRange) {
            // Simplified conversion logic for testing
            const filteredTopLevel = dateRange ? 
                topLevelData.filter(row => row.date >= dateRange.start && row.date <= dateRange.end) : 
                topLevelData;
            
            const filteredAdSet = dateRange ?
                adSetData.filter(row => row.date >= dateRange.start && row.date <= dateRange.end) :
                adSetData;

            // Top level aggregations
            const totalSessions = filteredTopLevel.reduce((sum, row) => 
                sum + (row.sessions > 0 ? row.sessions : 0), 0);
            const totalUsers = filteredTopLevel.reduce((sum, row) => 
                sum + (row.totalUsers > 0 ? row.totalUsers : 0), 0);
            const totalRevenue = filteredTopLevel.reduce((sum, row) => 
                sum + (row.revenue > 0 ? row.revenue : 0), 0);

            // AdSet groupings
            const adSetMetrics = {};
            filteredAdSet.forEach(row => {
                const key = `${row.campaignName}__${row.adSetName}`;
                if (!adSetMetrics[key]) {
                    adSetMetrics[key] = {
                        campaignName: row.campaignName,
                        adSetName: row.adSetName,
                        sessions: 0,
                        totalUsers: 0,
                        revenue: 0,
                        spent: 0,
                        rows: 0
                    };
                }
                
                if (row.sessions > 0) adSetMetrics[key].sessions += row.sessions;
                if (row.totalUsers > 0) adSetMetrics[key].totalUsers += row.totalUsers;
                if (row.revenue > 0) adSetMetrics[key].revenue += row.revenue;
                if (row.adSetLevelSpent > 0) adSetMetrics[key].spent += row.adSetLevelSpent;
                adSetMetrics[key].rows++;
            });

            return {
                topLevel: {
                    totalSessions: totalSessions || -999,
                    totalUsers: totalUsers || -999,
                    totalRevenue: totalRevenue || -999,
                    rowCount: filteredTopLevel.length
                },
                adSets: Object.values(adSetMetrics),
                summary: {
                    topLevelRows: filteredTopLevel.length,
                    adSetRows: filteredAdSet.length,
                    adSetGroups: Object.keys(adSetMetrics).length
                }
            };
        }

        function addTestPanel(title, content, status = 'info') {
            const panel = document.createElement('div');
            panel.className = `test-panel ${status}`;
            panel.innerHTML = `<h2>${title}</h2>${content}`;
            document.getElementById('test-results').appendChild(panel);
        }

        async function runIntegrationTests() {
            // Step 1: Load both CSV files
            addTestPanel(
                'üìÇ Step 1: Loading CSV Output Files',
                '<div class="test-step">Loading AdSet Level CSV...</div><div class="test-step">Loading Top Level CSV...</div>',
                'info'
            );

            let adSetCSV = '', topLevelCSV = '';
            try {
                const [adSetResponse, topLevelResponse] = await Promise.all([
                    fetch('../MOI_Sample_Output_Generation/05_CSV_Outputs/AI Generated - Adset Level Matrices.csv'),
                    fetch('../MOI_Sample_Output_Generation/05_CSV_Outputs/AI Generated - Top Level Daily Metrics_Complete.csv')
                ]);

                adSetCSV = await adSetResponse.text();
                topLevelCSV = await topLevelResponse.text();

                addTestPanel(
                    '‚úÖ Step 1 Results: CSV Files Loaded',
                    `<div class="metric-card">
                         <strong>AdSet CSV</strong><br>
                         ${adSetCSV.split('\n').length} lines<br>
                         ${Math.round(adSetCSV.length / 1024)} KB
                     </div>
                     <div class="metric-card">
                         <strong>Top Level CSV</strong><br>
                         ${topLevelCSV.split('\n').length} lines<br>
                         ${Math.round(topLevelCSV.length / 1024)} KB
                     </div>`,
                    'success'
                );

            } catch (error) {
                addTestPanel(
                    '‚ùå Step 1 Failed: CSV Loading Error',
                    `<p><strong>Error:</strong> ${error.message}</p>`,
                    'error'
                );
                return;
            }

            // Step 2: Parse CSV files
            addTestPanel(
                '‚öôÔ∏è Step 2: Parsing CSV Data',
                '<div class="test-step">Running parseAdSetCSV()...</div><div class="test-step">Running parseTopLevelCSV()...</div>',
                'info'
            );

            let adSetData = [], topLevelData = [];
            try {
                adSetData = parseAdSetCSV(adSetCSV);
                topLevelData = parseTopLevelCSV(topLevelCSV);

                // Sample first few rows for validation
                const adSetSample = adSetData.slice(0, 3).map((row, i) => 
                    `<tr>
                        <td>AdSet ${i+1}</td>
                        <td>${row.date}</td>
                        <td>${row.campaignName}</td>
                        <td>${row.adSetName}</td>
                        <td>${row.sessions}</td>
                        <td>${row.totalUsers}</td>
                        <td>${row.adSetLevelSpent}</td>
                    </tr>`
                ).join('');

                const topLevelSample = topLevelData.slice(0, 3).map((row, i) => 
                    `<tr>
                        <td>Top ${i+1}</td>
                        <td>${row.date}</td>
                        <td>${row.sessions}</td>
                        <td>${row.totalUsers}</td>
                        <td>${row.revenue}</td>
                    </tr>`
                ).join('');

                addTestPanel(
                    '‚úÖ Step 2 Results: CSV Parsing Success',
                    `<div class="metric-card">
                         <strong>AdSet Data</strong><br>
                         ${adSetData.length} rows parsed
                     </div>
                     <div class="metric-card">
                         <strong>Top Level Data</strong><br>
                         ${topLevelData.length} rows parsed
                     </div>
                     
                     <h3>AdSet Sample Data:</h3>
                     <table>
                         <tr><th>Row</th><th>Date</th><th>Campaign</th><th>AdSet</th><th>Sessions</th><th>Users</th><th>Spent</th></tr>
                         ${adSetSample}
                     </table>
                     
                     <h3>Top Level Sample Data:</h3>
                     <table>
                         <tr><th>Row</th><th>Date</th><th>Sessions</th><th>Users</th><th>Revenue</th></tr>
                         ${topLevelSample}
                     </table>`,
                    'success'
                );

            } catch (error) {
                addTestPanel(
                    '‚ùå Step 2 Failed: CSV Parsing Error',
                    `<p><strong>Error:</strong> ${error.message}</p>`,
                    'error'
                );
                return;
            }

            // Step 3: Test conversion function
            addTestPanel(
                'üîÑ Step 3: Testing convertOutputFilesToDashboard()',
                '<div class="test-step">Running conversion logic...</div>',
                'info'
            );

            let newDashboardData = {};
            try {
                newDashboardData = convertOutputFilesToDashboard(topLevelData, adSetData);

                addTestPanel(
                    '‚úÖ Step 3 Results: Dashboard Conversion Success',
                    `<div class="metric-card">
                         <strong>Total Sessions</strong><br>
                         ${newDashboardData.topLevel.totalSessions.toLocaleString()}
                     </div>
                     <div class="metric-card">
                         <strong>Total Users</strong><br>
                         ${newDashboardData.topLevel.totalUsers.toLocaleString()}
                     </div>
                     <div class="metric-card">
                         <strong>Total Revenue</strong><br>
                         ‚Çπ${newDashboardData.topLevel.totalRevenue.toLocaleString()}
                     </div>
                     <div class="metric-card">
                         <strong>AdSet Groups</strong><br>
                         ${newDashboardData.summary.adSetGroups} unique combinations
                     </div>
                     
                     <h3>Top 5 AdSet Groups by Revenue:</h3>
                     <table>
                         <tr><th>Campaign</th><th>AdSet</th><th>Sessions</th><th>Users</th><th>Revenue</th><th>Spent</th></tr>
                         ${newDashboardData.adSets
                             .sort((a, b) => b.revenue - a.revenue)
                             .slice(0, 5)
                             .map(adSet => `
                                 <tr>
                                     <td>${adSet.campaignName}</td>
                                     <td>${adSet.adSetName}</td>
                                     <td>${adSet.sessions}</td>
                                     <td>${adSet.totalUsers}</td>
                                     <td>‚Çπ${adSet.revenue}</td>
                                     <td>‚Çπ${adSet.spent}</td>
                                 </tr>
                             `).join('')}
                     </table>`,
                    'success'
                );

            } catch (error) {
                addTestPanel(
                    '‚ùå Step 3 Failed: Dashboard Conversion Error',
                    `<p><strong>Error:</strong> ${error.message}</p>`,
                    'error'
                );
                return;
            }

            // Step 4: Compare with current dashboard data
            addTestPanel(
                '‚öñÔ∏è Step 4: Comparing with Current Dashboard Data',
                '<div class="test-step">Loading current localStorage data...</div>',
                'info'
            );

            try {
                const currentDataRaw = localStorage.getItem('moi-data');
                if (!currentDataRaw) {
                    addTestPanel(
                        '‚ö†Ô∏è Step 4 Results: No Current Data for Comparison',
                        `<p>No current dashboard data found in localStorage. This might be expected if this is the first run.</p>
                         <p><strong>Recommendation:</strong> Load the dashboard normally first to populate localStorage, then run this test.</p>`,
                        'warning'
                    );
                } else {
                    const currentData = JSON.parse(currentDataRaw);
                    
                    // Calculate current metrics for comparison
                    const currentSessions = currentData.reduce((sum, row) => sum + (row.sessions || 0), 0);
                    const currentUsers = currentData.reduce((sum, row) => sum + (row.totalUsers || 0), 0);
                    const currentRevenue = currentData.reduce((sum, row) => sum + (row.revenue || 0), 0);

                    const comparison = [
                        {
                            metric: 'Total Sessions',
                            current: currentSessions,
                            new: newDashboardData.topLevel.totalSessions,
                            diff: newDashboardData.topLevel.totalSessions - currentSessions
                        },
                        {
                            metric: 'Total Users', 
                            current: currentUsers,
                            new: newDashboardData.topLevel.totalUsers,
                            diff: newDashboardData.topLevel.totalUsers - currentUsers
                        },
                        {
                            metric: 'Total Revenue',
                            current: currentRevenue,
                            new: newDashboardData.topLevel.totalRevenue,
                            diff: newDashboardData.topLevel.totalRevenue - currentRevenue
                        }
                    ];

                    const comparisonTable = comparison.map(comp => {
                        const diffColor = comp.diff === 0 ? '#28a745' : 
                                        Math.abs(comp.diff) < Math.abs(comp.current) * 0.1 ? '#ffc107' : '#dc3545';
                        const diffPercent = comp.current !== 0 ? ((comp.diff / comp.current) * 100).toFixed(1) : 'N/A';
                        
                        return `<tr style="border-left: 4px solid ${diffColor}">
                            <td><strong>${comp.metric}</strong></td>
                            <td>${comp.current.toLocaleString()}</td>
                            <td>${comp.new.toLocaleString()}</td>
                            <td style="color: ${diffColor}; font-weight: bold;">
                                ${comp.diff > 0 ? '+' : ''}${comp.diff.toLocaleString()} 
                                (${diffPercent}%)
                            </td>
                        </tr>`;
                    }).join('');

                    addTestPanel(
                        'üìä Step 4 Results: Data Comparison Analysis',
                        `<table class="compare-table">
                             <tr><th>Metric</th><th>Current Dashboard</th><th>New CSV-Based</th><th>Difference</th></tr>
                             ${comparisonTable}
                         </table>
                         
                         <div class="metric-card">
                             <strong>Current Data Rows</strong><br>
                             ${currentData.length}
                         </div>
                         <div class="metric-card">
                             <strong>New Data Points</strong><br>
                             Top: ${newDashboardData.summary.topLevelRows}<br>
                             AdSet: ${newDashboardData.summary.adSetRows}
                         </div>`,
                        'success'
                    );
                }

            } catch (error) {
                addTestPanel(
                    '‚ùå Step 4 Failed: Data Comparison Error',
                    `<p><strong>Error:</strong> ${error.message}</p>`,
                    'error'
                );
            }

            // Final Summary
            addTestPanel(
                'üéØ Phase 1 Integration Test Summary',
                `<div style="text-align: center;">
                     <div class="metric-card">
                         <strong>CSV Parsing</strong><br>
                         <span class="status-badge pass">PASS</span>
                     </div>
                     <div class="metric-card">
                         <strong>Data Conversion</strong><br>
                         <span class="status-badge pass">PASS</span>
                     </div>
                     <div class="metric-card">
                         <strong>Structure Validation</strong><br>
                         <span class="status-badge pass">PASS</span>
                     </div>
                     <div class="metric-card">
                         <strong>Ready for Phase 1.2</strong><br>
                         <span class="status-badge pass">YES</span>
                     </div>
                 </div>
                 
                 <h3>‚úÖ What's Working:</h3>
                 <ul>
                     <li>CSV files are accessible and parseable</li>
                     <li>parseAdSetCSV() and parseTopLevelCSV() functions work correctly</li>
                     <li>convertOutputFilesToDashboard() produces expected data structure</li>
                     <li>Data aggregation logic is functioning</li>
                     <li>AdSet grouping by Campaign+AdSet works</li>
                 </ul>
                 
                 <h3>üîÑ Next Steps:</h3>
                 <ul>
                     <li><strong>Phase 1.2:</strong> Create dashboard integration with the new converter</li>
                     <li><strong>Phase 1.3:</strong> Switch main data flow to use output files</li>
                     <li><strong>Phase 2:</strong> Fix -999 sentinel value handling once architecture is solid</li>
                 </ul>`,
                'success'
            );
        }

        // Run integration tests
        runIntegrationTests().catch(error => {
            addTestPanel(
                'üí• Critical Integration Test Failure',
                `<p><strong>Error:</strong> ${error.message}</p>
                 <p><strong>Stack:</strong> ${error.stack}</p>`,
                'error'
            );
        });
    </script>
</body>
</html>